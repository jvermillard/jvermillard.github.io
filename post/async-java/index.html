<!doctype html><html dir=ltr lang=en data-theme class=html><head><title>Life and death of Java asynchronous network programming |
Julien Vermillard
</title><meta charset=utf-8><meta name=generator content="Hugo 0.124.1"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=author content="Julien Vermillard"><meta name=description content="
      Julien Vermillard


    "><link rel=stylesheet href=/scss/main.min.5259d55db7b9c675f751f0865411bd84a410f3ffcb5105b8fc00b22fcb739309.css integrity="sha256-UlnVXbe5xnX3UfCGVBG9hKQQ8//LUQW4/ACyL8tzkwk=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/css/markupHighlight.min.31b0a1f317f55c529a460897848c97436bb138b19c399b37de70d463a8bf6ed5.css integrity="sha256-MbCh8xf1XFKaRgiXhIyXQ2uxOLGcOZs33nDUY6i/btU=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/fontawesome/css/fontawesome.min.69685904d5c2a0c6258d03c207b778c10466edf6cea928cc0164c376b0ad0930.css integrity="sha256-aWhZBNXCoMYljQPCB7d4wQRm7fbOqSjMAWTDdrCtCTA=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/fontawesome/css/solid.min.6d585e78d28cce1200d39fb133c92ed83df01738da721d0f48fb6eac62d24e04.css integrity="sha256-bVheeNKMzhIA05+xM8ku2D3wFzjach0PSPturGLSTgQ=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/fontawesome/css/brands.min.6b00d96498d59caa0dbcf9b49d30d821915291f2ceb0e19248523c8607ff43fa.css integrity="sha256-awDZZJjVnKoNvPm0nTDYIZFSkfLOsOGSSFI8hgf/Q/o=" crossorigin=anonymous type=text/css><link rel="shortcut icon" href=/favicons/favicon.ico type=image/x-icon><link rel=apple-touch-icon sizes=180x180 href=/favicons/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicons/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicons/favicon-16x16.png><link rel=canonical href=http://vermillard.com/post/async-java/><script type=text/javascript src=/js/anatole-header.min.f9132794301a01ff16550ed66763482bd848f62243d278f5e550229a158bfd32.js integrity="sha256-+RMnlDAaAf8WVQ7WZ2NIK9hI9iJD0nj15VAimhWL/TI=" crossorigin=anonymous></script><script type=text/javascript src=/js/anatole-theme-switcher.min.738c0e3a493854876aeab9e2316fd43f1936aeeac4cc6b3e60bb26456dba72ad.js integrity="sha256-c4wOOkk4VIdq6rniMW/UPxk2rurEzGs+YLsmRW26cq0=" crossorigin=anonymous></script><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://vermillard.com/images/site-feature-image.png"><meta name=twitter:title content="Life and death of Java asynchronous network programming"><meta name=twitter:description content="Network programming in Java has changed significantly over the last 20+ years."><meta property="og:title" content="Life and death of Java asynchronous network programming"><meta property="og:description" content="Network programming in Java has changed significantly over the last 20+ years."><meta property="og:type" content="article"><meta property="og:url" content="http://vermillard.com/post/async-java/"><meta property="og:image" content="http://vermillard.com/images/site-feature-image.png"><meta property="article:section" content="post"><meta property="article:published_time" content="2024-08-18T00:00:00+00:00"><meta property="article:modified_time" content="2024-08-18T00:00:00+00:00"><meta property="og:site_name" content="About Me"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","articleSection":"post","name":"Life and death of Java asynchronous network programming","headline":"Life and death of Java asynchronous network programming","alternativeHeadline":"","description":"
      
        Network programming in Java has changed significantly over the last 20\u002b years.


      


    ","inLanguage":"en","isFamilyFriendly":"true","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/vermillard.com\/post\/async-java\/"},"author":{"@type":"Person","name":"Julien Vermillard"},"creator":{"@type":"Person","name":"Julien Vermillard"},"accountablePerson":{"@type":"Person","name":"Julien Vermillard"},"copyrightHolder":{"@type":"Person","name":"Julien Vermillard"},"copyrightYear":"2024","dateCreated":"2024-08-18T00:00:00.00Z","datePublished":"2024-08-18T00:00:00.00Z","dateModified":"2024-08-18T00:00:00.00Z","publisher":{"@type":"Organization","name":"Julien Vermillard","url":"http://vermillard.com/","logo":{"@type":"ImageObject","url":"http:\/\/vermillard.com\/favicons\/favicon-32x32.png","width":"32","height":"32"}},"image":["http://vermillard.com/images/site-feature-image.png"],"url":"http:\/\/vermillard.com\/post\/async-java\/","wordCount":"1864","genre":[],"keywords":["Java","network programming","asynchronous"]}</script></head><body class="body theme--light"><div class=wrapper><aside class=wrapper__sidebar><div class="sidebar
animated fadeInDown"><div class=sidebar__content><div class=sidebar__introduction><img class=sidebar__introduction-profileimage src=/images/profile.png alt="profile picture"><h1 class=sidebar__introduction-title><a href=/>About Me</a></h1><div class=sidebar__introduction-description><p>Julien Vermillard</p></div></div><ul class=sidebar__list><li class=sidebar__list-item><a href=https://linkedin.com/in/jvermillard/ rel=me aria-label=Linkedin title=Linkedin><i class="fab fa-linkedin fa-2x" aria-hidden=true></i></a></li><li class=sidebar__list-item><a href=https://twitter.com/vrmvrm rel=me aria-label=Twitter title=Twitter><i class="fab fa-twitter fa-2x" aria-hidden=true></i></a></li><li class=sidebar__list-item><a href=https://github.com/jvermillard/ rel=me aria-label=GitHub title=GitHub><i class="fab fa-github fa-2x" aria-hidden=true></i></a></li><li class=sidebar__list-item><a href=mailto:julien@vermillard.com rel=me aria-label=e-mail title=e-mail><i class="fas fa-envelope fa-2x" aria-hidden=true></i></a></li><li class=sidebar__list-item><a href=/documents/cv.pdf rel=me aria-label=resume title=resume><i class="fas fa-file-pdf fa-2x" aria-hidden=true></i></a></li></ul></div><footer class="footer footer__sidebar"><ul class=footer__list><li class=footer__item>&copy;
2021 - 2024</li></ul></footer><script type=text/javascript src=/js/medium-zoom.min.1248fa75275e5ef0cbef27e8c1e27dc507c445ae3a2c7d2ed0be0809555dac64.js integrity="sha256-Ekj6dSdeXvDL7yfoweJ9xQfERa46LH0u0L4ICVVdrGQ=" crossorigin=anonymous></script></div></aside><main class=wrapper__main><header class=header><div class="animated fadeInDown"><a role=button class=navbar-burger data-target=navMenu aria-label=menu aria-expanded=false><span aria-hidden=true class=navbar-burger__line></span>
<span aria-hidden=true class=navbar-burger__line></span>
<span aria-hidden=true class=navbar-burger__line></span></a><nav class=nav><ul class=nav__list id=navMenu><li class=nav__list-item><a href=/ title>Home</a></li><li class=nav__list-item><a href=/post/ title>Posts</a></li><li class=nav__list-item><a href=/portfolio/ title>Portfolio</a></li><li class=nav__list-item><a href=/publicspeaking/ title>Public Speaking</a></li></ul><ul class="nav__list nav__list--end"><li class=nav__list-item><div class=themeswitch><a title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></li></ul></nav></div></header><div class="post
animated fadeInDown"><div class=post__content><h1>Life and Death of Java Asynchronous Network Programming</h1><ul class=post__meta><li class=post__meta-item><em class="fas fa-calendar-day post__meta-icon"></em>
<span class=post__meta-text>18/8/2024</span></li><li class=post__meta-item><em class="fas fa-stopwatch post__meta-icon"></em>
<span class=post__meta-text>9-minute read</span></li></ul><p>Network programming in Java has changed significantly over the last 20+ years. Mainly driven by the desire to handle larger loads by an ever-increasing number of connections.</p><p>In Java, the journey started with synchronous programming, using one thread per connection (to a server or a connected client). The principal limit was memory because each thread cost approximately half a megabyte (maybe less with some tuning).</p><p>This would look like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>import java.io.*;
</span></span><span class=line><span class=cl>import java.net.*;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>public class SimpleTcpServer {
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    public static void main(String[] args) {
</span></span><span class=line><span class=cl>        int port = 1234;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        ServerSocket serverSocket = new ServerSocket(port);
</span></span><span class=line><span class=cl>        while (true) {
</span></span><span class=line><span class=cl>           // Accept a new client connection
</span></span><span class=line><span class=cl>           Socket clientSocket = serverSocket.accept();
</span></span><span class=line><span class=cl>           System.out.println(&#34;New connection from &#34; + clientSocket.getInetAddress().getHostAddress());
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>           // Start a new thread to handle the connection
</span></span><span class=line><span class=cl>           new Thread(new ClientHandler(clientSocket)).start();
</span></span><span class=line><span class=cl>       }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>class ClientHandler implements Runnable {
</span></span><span class=line><span class=cl>    private final Socket clientSocket;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    public ClientHandler(Socket clientSocket) {
</span></span><span class=line><span class=cl>        this.clientSocket = clientSocket;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    @Override
</span></span><span class=line><span class=cl>    public void run() {
</span></span><span class=line><span class=cl>        try {
</span></span><span class=line><span class=cl>            BufferedReader in = new BufferedReader(new InputStreamReader(clientSocket.getInputStream()));
</span></span><span class=line><span class=cl>            PrintWriter out = new PrintWriter(clientSocket.getOutputStream(), true);
</span></span><span class=line><span class=cl>            String message;
</span></span><span class=line><span class=cl>            while ((message = in.readLine()) != null) {
</span></span><span class=line><span class=cl>                System.out.println(&#34;Received: &#34; + message);
</span></span><span class=line><span class=cl>                out.println(&#34;Echo: &#34; + message);
</span></span><span class=line><span class=cl>            }
</span></span><span class=line><span class=cl>        } catch (IOException e) {
</span></span><span class=line><span class=cl>            e.printStackTrace();
</span></span><span class=line><span class=cl>        } finally {
</span></span><span class=line><span class=cl>            clientSocket.close();
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>At the time (early 2000s), I was working on monitoring appliances running on 64 MB of RAM. The one thread per connection model worked fine until a new project arrived: I needed to connect to 1k IP devices to monitor them, and the classical one thread per connection model consumed twenty times more memory than I could afford.</p><h2 id=the-c10k-problem>The C10K Problem</h2><p>The C10K problem emerged in the late 1990s, highlighting the server’s challenge in handling more than 10,000 TCP connections. We started to see different proposals to change or evolve the traditional network programming model. The main idea was to remove the reliance on threads to reduce memory consumption and the massive performance impact of context switching.</p><p>See:
<a href=http://www.kegel.com/c10k.html>http://www.kegel.com/c10k.html</a>
<a href=https://en.wikipedia.org/wiki/C10k_problem>https://en.wikipedia.org/wiki/C10k_problem</a></p><h2 id=the-advent-of-nio-java-14>The Advent of NIO (Java 1.4)</h2><p>In light of the problem raised by the C10K problem, Java 1.4 (released in 2002) introduced the New Input/Output (NIO) library, providing a non-blocking I/O model that significantly improved scalability. NIO allowed multiple connections (called Channels) to be managed by a single thread using selectors. Selectors would generate events when a connection is ready to be read (e.g., some data was received and buffered by the kernel), prepared to be written, or closed. The programming model changed from blocking synchronous threads to an event-driven one.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// over simplified NIO event loop example:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Selectot</span><span class=w> </span><span class=n>selector</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Selector</span><span class=p>.</span><span class=na>open</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ServerSocketChannel</span><span class=w> </span><span class=n>serverChannel</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ServerSocketChannel</span><span class=p>.</span><span class=na>open</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>serverChannel</span><span class=p>.</span><span class=na>configureBlocking</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// Bind the socket to TCP server port</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>serverChannel</span><span class=p>.</span><span class=na>socket</span><span class=p>().</span><span class=na>bind</span><span class=p>(</span><span class=s>&#34;0.0.0.0:1234&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>serverChannel</span><span class=p>.</span><span class=na>register</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>selector</span><span class=p>,</span><span class=w> </span><span class=n>SelectionKey</span><span class=p>.</span><span class=na>OP_ACCEPT</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;Server bind and started…&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// event loop</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>this</span><span class=p>.</span><span class=na>selector</span><span class=p>.</span><span class=na>select</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>Iterator</span><span class=w> </span><span class=n>keys</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>selector</span><span class=p>.</span><span class=na>selectedKeys</span><span class=p>().</span><span class=na>iterator</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>keys</span><span class=p>.</span><span class=na>hasNext</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>SelectionKey</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>SelectionKey</span><span class=p>)</span><span class=w> </span><span class=n>keys</span><span class=p>.</span><span class=na>next</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c1>// remove the processed event</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>keys</span><span class=p>.</span><span class=na>remove</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>key</span><span class=p>.</span><span class=na>isValid</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=k>continue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>key</span><span class=p>.</span><span class=na>isAcceptable</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>accept</span><span class=p>(</span><span class=n>key</span><span class=p>);</span><span class=w> </span><span class=c1>// TODO</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>key</span><span class=p>.</span><span class=na>isReadable</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>read</span><span class=p>(</span><span class=n>key</span><span class=p>);</span><span class=w> </span><span class=c1>// TODO</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>key</span><span class=p>.</span><span class=na>isWritable</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>write</span><span class=p>(</span><span class=n>key</span><span class=p>);</span><span class=w> </span><span class=c1>// TODO</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>This new model allowed handling thousands of connections with a few threads, effectively addressing the C10K problem.</p><h2 id=the-birth-of-java-asynchronous-networking-programming>The birth of Java asynchronous networking programming</h2><p>While in C/C++, it’s frequently used to select/poll/queue directly. Java NIO is quite a complicated API and buggy (SSL engine quirks or spinning selector without events) to be used directly. If you skim Stackoverflow, you will see that it’s pretty challenging to get NIO right.</p><p>What complicates NIO is Sun’s attempt to unify Unix-style networking (BSD socket) with Microsoft Windows (Winsock). Also, event-driven programming in plain Java took a lot of work at the time. You were asking programmers used to synchronous POO to start to write asynchronous code, using mainly state machines (lambda/functional programming was not yet a thing in Java).</p><p>Example of an HTTP decoding state machine: <a href=https://github.com/netty/netty/blob/4.1/codec-http/src/main/java/io/netty/handler/codec/http/HttpObjectDecoder.java#L338>https://github.com/netty/netty/blob/4.1/codec-http/src/main/java/io/netty/handler/codec/http/HttpObjectDecoder.java#L338</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>        </span><span class=k>switch</span><span class=w> </span><span class=p>(</span><span class=n>currentState</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>case</span><span class=w> </span><span class=n>SKIP_CONTROL_CHARS</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Fall-through</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>case</span><span class=w> </span><span class=n>READ_INITIAL</span><span class=p>:</span><span class=w> </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ByteBuf</span><span class=w> </span><span class=n>line</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lineParser</span><span class=p>.</span><span class=na>parse</span><span class=p>(</span><span class=n>buffer</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>line</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>initialLine</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>splitInitialLine</span><span class=p>(</span><span class=n>line</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>assert</span><span class=w> </span><span class=n>initialLine</span><span class=p>.</span><span class=na>length</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>3</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s>&#34;initialLine::length must be 3&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>message</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>createMessage</span><span class=p>(</span><span class=n>initialLine</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>currentState</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>State</span><span class=p>.</span><span class=na>READ_HEADER</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// fall-through</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>out</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>invalidMessage</span><span class=p>(</span><span class=n>message</span><span class=p>,</span><span class=w> </span><span class=n>buffer</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>case</span><span class=w> </span><span class=n>READ_HEADER</span><span class=p>:</span><span class=w> </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>State</span><span class=w> </span><span class=n>nextState</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>readHeaders</span><span class=p>(</span><span class=n>buffer</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>nextState</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>currentState</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>nextState</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>switch</span><span class=w> </span><span class=p>(</span><span class=n>nextState</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=n>SKIP_CONTROL_CHARS</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// fast-path</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// No content is expected.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>addCurrentMessage</span><span class=p>(</span><span class=n>out</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>out</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>LastHttpContent</span><span class=p>.</span><span class=na>EMPTY_LAST_CONTENT</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>resetNow</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>case</span><span class=w> </span><span class=n>READ_CHUNK_SIZE</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>chunkedSupported</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&#34;Chunked messages not supported&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Chunked encoding - generate HttpMessage first.  HttpChunks will follow.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>addCurrentMessage</span><span class=p>(</span><span class=n>out</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>                 * RFC 7230, 3.3.3 (https://tools.ietf.org/html/rfc7230#section-3.3.3) states that if a
</span></span></span><span class=line><span class=cl><span class=cm>                 * request does not have either a transfer-encoding or a content-length header then the message body
</span></span></span><span class=line><span class=cl><span class=cm>                 * length is 0. However, for a response the body length is the number of octets received prior to the
</span></span></span><span class=line><span class=cl><span class=cm>                 * server closing the connection. So we treat this as variable length chunked encoding.
</span></span></span><span class=line><span class=cl><span class=cm>                 */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>contentLength</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>contentLength</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=o>-</span><span class=n>1</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>isDecodingRequest</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>addCurrentMessage</span><span class=p>(</span><span class=n>out</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>out</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>LastHttpContent</span><span class=p>.</span><span class=na>EMPTY_LAST_CONTENT</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>resetNow</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>assert</span><span class=w> </span><span class=n>nextState</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>State</span><span class=p>.</span><span class=na>READ_FIXED_LENGTH_CONTENT</span><span class=w> </span><span class=o>||</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>nextState</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>State</span><span class=p>.</span><span class=na>READ_VARIABLE_LENGTH_CONTENT</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>addCurrentMessage</span><span class=p>(</span><span class=n>out</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>nextState</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>State</span><span class=p>.</span><span class=na>READ_FIXED_LENGTH_CONTENT</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// chunkSize will be decreased as the READ_FIXED_LENGTH_CONTENT state reads data chunk by chunk.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>chunkSize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>contentLength</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// We return here, this forces decode to be called again where we will decode the content</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>out</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>invalidMessage</span><span class=p>(</span><span class=n>message</span><span class=p>,</span><span class=w> </span><span class=n>buffer</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>case</span><span class=w> </span><span class=n>READ_VARIABLE_LENGTH_CONTENT</span><span class=p>:</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Keep reading data as a chunk until the end of connection is reached.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>toRead</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Math</span><span class=p>.</span><span class=na>min</span><span class=p>(</span><span class=n>buffer</span><span class=p>.</span><span class=na>readableBytes</span><span class=p>(),</span><span class=w> </span><span class=n>maxChunkSize</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>toRead</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>ByteBuf</span><span class=w> </span><span class=n>content</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>buffer</span><span class=p>.</span><span class=na>readRetainedSlice</span><span class=p>(</span><span class=n>toRead</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>out</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>DefaultHttpContent</span><span class=p>(</span><span class=n>content</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>case</span><span class=w> </span><span class=n>READ_FIXED_LENGTH_CONTENT</span><span class=p>:</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>readLimit</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>buffer</span><span class=p>.</span><span class=na>readableBytes</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Check if the buffer is readable first as we use the readable byte count</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// to create the HttpChunk. This is needed as otherwise we may end up with</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// create an HttpChunk instance that contains an empty buffer and so is</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// handled like it is the last HttpChunk.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// See https://github.com/netty/netty/issues/433</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>readLimit</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>toRead</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Math</span><span class=p>.</span><span class=na>min</span><span class=p>(</span><span class=n>readLimit</span><span class=p>,</span><span class=w> </span><span class=n>maxChunkSize</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>toRead</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>chunkSize</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>toRead</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=w> </span><span class=n>chunkSize</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ByteBuf</span><span class=w> </span><span class=n>content</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>buffer</span><span class=p>.</span><span class=na>readRetainedSlice</span><span class=p>(</span><span class=n>toRead</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>chunkSize</span><span class=w> </span><span class=o>-=</span><span class=w> </span><span class=n>toRead</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>chunkSize</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Read all content.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>out</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>DefaultLastHttpContent</span><span class=p>(</span><span class=n>content</span><span class=p>,</span><span class=w> </span><span class=n>trailersFactory</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>resetNow</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>out</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>DefaultHttpContent</span><span class=p>(</span><span class=n>content</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>         * everything else after this point takes care of reading chunked content. basically, read chunk size,
</span></span></span><span class=line><span class=cl><span class=cm>         * read chunk, read and ignore the CRLF and repeat until 0
</span></span></span><span class=line><span class=cl><span class=cm>         */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>case</span><span class=w> </span><span class=n>READ_CHUNK_SIZE</span><span class=p>:</span><span class=w> </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ByteBuf</span><span class=w> </span><span class=n>line</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lineParser</span><span class=p>.</span><span class=na>parse</span><span class=p>(</span><span class=n>buffer</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>line</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>chunkSize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getChunkSize</span><span class=p>(</span><span class=n>line</span><span class=p>.</span><span class=na>array</span><span class=p>(),</span><span class=w> </span><span class=n>line</span><span class=p>.</span><span class=na>arrayOffset</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>line</span><span class=p>.</span><span class=na>readerIndex</span><span class=p>(),</span><span class=w> </span><span class=n>line</span><span class=p>.</span><span class=na>readableBytes</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>chunkSize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>chunkSize</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>chunkSize</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>currentState</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>State</span><span class=p>.</span><span class=na>READ_CHUNK_FOOTER</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>currentState</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>State</span><span class=p>.</span><span class=na>READ_CHUNKED_CONTENT</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// fall-through</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>out</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>invalidChunk</span><span class=p>(</span><span class=n>buffer</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>case</span><span class=w> </span><span class=n>READ_CHUNKED_CONTENT</span><span class=p>:</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>assert</span><span class=w> </span><span class=n>chunkSize</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>Integer</span><span class=p>.</span><span class=na>MAX_VALUE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>toRead</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Math</span><span class=p>.</span><span class=na>min</span><span class=p>((</span><span class=kt>int</span><span class=p>)</span><span class=w> </span><span class=n>chunkSize</span><span class=p>,</span><span class=w> </span><span class=n>maxChunkSize</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>allowPartialChunks</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>buffer</span><span class=p>.</span><span class=na>readableBytes</span><span class=p>()</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>toRead</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>toRead</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Math</span><span class=p>.</span><span class=na>min</span><span class=p>(</span><span class=n>toRead</span><span class=p>,</span><span class=w> </span><span class=n>buffer</span><span class=p>.</span><span class=na>readableBytes</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>toRead</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>HttpContent</span><span class=w> </span><span class=n>chunk</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DefaultHttpContent</span><span class=p>(</span><span class=n>buffer</span><span class=p>.</span><span class=na>readRetainedSlice</span><span class=p>(</span><span class=n>toRead</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>chunkSize</span><span class=w> </span><span class=o>-=</span><span class=w> </span><span class=n>toRead</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>out</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>chunk</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>chunkSize</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>currentState</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>State</span><span class=p>.</span><span class=na>READ_CHUNK_DELIMITER</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// fall-through</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>case</span><span class=w> </span><span class=n>READ_CHUNK_DELIMITER</span><span class=p>:</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>wIdx</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>buffer</span><span class=p>.</span><span class=na>writerIndex</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>rIdx</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>buffer</span><span class=p>.</span><span class=na>readerIndex</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>wIdx</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>rIdx</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>byte</span><span class=w> </span><span class=n>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>buffer</span><span class=p>.</span><span class=na>getByte</span><span class=p>(</span><span class=n>rIdx</span><span class=o>++</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>next</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>HttpConstants</span><span class=p>.</span><span class=na>LF</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>currentState</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>State</span><span class=p>.</span><span class=na>READ_CHUNK_SIZE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>buffer</span><span class=p>.</span><span class=na>readerIndex</span><span class=p>(</span><span class=n>rIdx</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>case</span><span class=w> </span><span class=n>READ_CHUNK_FOOTER</span><span class=p>:</span><span class=w> </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>LastHttpContent</span><span class=w> </span><span class=n>trailer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>readTrailingHeaders</span><span class=p>(</span><span class=n>buffer</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>trailer</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>out</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>trailer</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>resetNow</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>out</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>invalidChunk</span><span class=p>(</span><span class=n>buffer</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>case</span><span class=w> </span><span class=n>BAD_MESSAGE</span><span class=p>:</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Keep discarding until disconnection.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>buffer</span><span class=p>.</span><span class=na>skipBytes</span><span class=p>(</span><span class=n>buffer</span><span class=p>.</span><span class=na>readableBytes</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>case</span><span class=w> </span><span class=n>UPGRADED</span><span class=p>:</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>readableBytes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>buffer</span><span class=p>.</span><span class=na>readableBytes</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>readableBytes</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Keep on consuming as otherwise we may trigger an DecoderException,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// other handler will replace this codec with the upgraded protocol codec to</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// take the traffic over at some point then.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// See https://github.com/netty/netty/issues/2173</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>out</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>buffer</span><span class=p>.</span><span class=na>readBytes</span><span class=p>(</span><span class=n>readableBytes</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>This is more complex to write than a synchronous-pulling parser, which would look like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>HttpRequest</span><span class=w> </span><span class=nf>decodeHttpRequest</span><span class=p>(</span><span class=n>BufferedReader</span><span class=w> </span><span class=n>in</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Read the request line</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>requestLine</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>in</span><span class=p>.</span><span class=na>readLine</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>requestLine</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>requestLine</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w> </span><span class=c1>// Invalid request</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Parse the request line</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>requestParts</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>requestLine</span><span class=p>.</span><span class=na>split</span><span class=p>(</span><span class=s>&#34; &#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>requestParts</span><span class=p>.</span><span class=na>length</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>3</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w> </span><span class=c1>// Invalid request line</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>method</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>requestParts</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>uri</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>requestParts</span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>httpVersion</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>requestParts</span><span class=o>[</span><span class=n>2</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Read and parse headers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>headers</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HashMap</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>headerLine</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>((</span><span class=n>headerLine</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>in</span><span class=p>.</span><span class=na>readLine</span><span class=p>())</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>headerLine</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>headerParts</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>headerLine</span><span class=p>.</span><span class=na>split</span><span class=p>(</span><span class=s>&#34;:&#34;</span><span class=p>,</span><span class=w> </span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>headerParts</span><span class=p>.</span><span class=na>length</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>2</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>headers</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>headerParts</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>.</span><span class=na>trim</span><span class=p>(),</span><span class=w> </span><span class=n>headerParts</span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=p>.</span><span class=na>trim</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Return the decoded HTTP request</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HttpRequest</span><span class=p>(</span><span class=n>method</span><span class=p>,</span><span class=w> </span><span class=n>uri</span><span class=p>,</span><span class=w> </span><span class=n>httpVersion</span><span class=p>,</span><span class=w> </span><span class=n>headers</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=the-advent-of-asynchronous-network-programming-frameworks>The advent of asynchronous network programming frameworks</h2><p>Apache MINA, Netty, Grizzly, xNIO, and probably more frameworks were created. Several techniques were tried to make async network programming more accessible and reliable, from VertX to reactive programming frameworks. The reactive programming paradigm deals with async data streams and change propagation. It helps you set up a series of transformations and operations on data that will be executed as the data arrives and processed as it flows in.</p><p>RxJava TCP server example: <a href=https://github.com/whybe/rxnetty-tcp-sample/blob/master/src/main/java/io/reactivex/netty/samples/SimpleTcpServer.Java>https://github.com/whybe/rxnetty-tcp-sample/blob/master/src/main/java/io/reactivex/netty/samples/SimpleTcpServer.Java</a></p><p>Introducing this programming style in popular Java frameworks changed how we built enterprise applications: You can’t continue to use blocking-style JDBC drivers or HTTP clients. For example, introducing reactive programming in the Spring framework marked a significant evolution from the traditional blocking-style RestTemplate or JdbcTemplate.</p><p>This created a major API and code paradigm shift, enabling more significant parallelism and scalability. However, this came at the cost of increased complexity and an often misunderstood hard-to-debug threading model.</p><h2 id=virtual-thread-asynchrony-obsolete>Virtual thread. Asynchrony obsolete?</h2><p>Java 21 (released in September 2023) introduced a new shift in network programming with the lightweight thread model. These new threads solve our initial connection scaling problem: memory cost! We go from a price range of hundreds of bytes to a few KBs.</p><p>Virtual threads are scheduled and preempted by the JVM in place of the O/S following the I/O event. For example, the scheduler will preempt a thread waiting for a network connection to receive some datagram, precisely like the O/S would do with a native thread, but at low memory cost while idling.</p><p>We can now use the 20-year-old synchronous programming model in a scalable way. This change alone makes the needs of async frameworks like Vert.x, Netty, Reactor, Flux… obsolete for most (or all?) use cases. Of course, after 20 years of errands in the realm of asynchronous programming and asynchronous framework, it’s a considerable disruption!</p><p>A myriad of libraries are not applicable anymore. You can now create a small Java 21 backend HTTP server from the std library: <a href=https://www.reddit.com/r/java/comments/18vysrr/jdk_http_server_handles_100000_reqsec_with_100_ms/>https://www.reddit.com/r/java/comments/18vysrr/jdk_http_server_handles_100000_reqsec_with_100_ms/</a></p><p>This causes quite some confusion in the Java community:</p><ul><li>Reddit: <a href=https://www.reddit.com/r/java/comments/1d43rbh/how_can_java_21_virtual_thread_replace_reactive/>https://www.reddit.com/r/java/comments/1d43rbh/how_can_java_21_virtual_thread_replace_reactive/</a></li><li>Netty GitHub issue: <a href=https://github.com/netty/netty/issues/12848>https://github.com/netty/netty/issues/12848</a></li><li>Spring <a href=https://spring.io/blog/2022/10/11/embracing-virtual-threads#revision-of-programming-models>https://spring.io/blog/2022/10/11/embracing-virtual-threads#revision-of-programming-models</a></li></ul><p>The confusion is in the air, but it makes me excited to return to Java after a long time, after looking at other ecosystems that embraced green/light threads, such as Go and Erlang/Elixir.</p><p>I’m happy we can use this opportunity to simplify our Java backend developer toolbox. We can remove a good chunk of the Spring framework layers and return to a simpler model: <a href=https://spring.io/blog/2023/07/13/new-in-spring-6-1-restclient>https://spring.io/blog/2023/07/13/new-in-spring-6-1-restclient</a></p><p>Async Network Programming served us well for 20 years as a way to mitigate the cost of threads in JVM, but it’s time to let it go and embrace a more accessible and manageable way.</p></div><div class=post__footer><span><a class=tag href=/tags/java/>Java</a><a class=tag href=/tags/network-programming/>network programming</a><a class=tag href=/tags/asynchronous/>asynchronous</a></span></div></div></main></div><footer class="footer footer__base"><ul class=footer__list><li class=footer__item>&copy;
2021 - 2024</li></ul></footer><script type=text/javascript src=/js/medium-zoom.min.1248fa75275e5ef0cbef27e8c1e27dc507c445ae3a2c7d2ed0be0809555dac64.js integrity="sha256-Ekj6dSdeXvDL7yfoweJ9xQfERa46LH0u0L4ICVVdrGQ=" crossorigin=anonymous></script></body></html>