<!doctype html><html dir=ltr lang=en data-theme class=html><head><title>IoT Traffic capture and analysis on AWS |
Julien Vermillard
</title><meta charset=utf-8><meta name=generator content="Hugo 0.124.1"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=author content="Julien Vermillard"><meta name=description content="
      Julien Vermillard


    "><link rel=stylesheet href=/scss/main.min.5259d55db7b9c675f751f0865411bd84a410f3ffcb5105b8fc00b22fcb739309.css integrity="sha256-UlnVXbe5xnX3UfCGVBG9hKQQ8//LUQW4/ACyL8tzkwk=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/css/markupHighlight.min.31b0a1f317f55c529a460897848c97436bb138b19c399b37de70d463a8bf6ed5.css integrity="sha256-MbCh8xf1XFKaRgiXhIyXQ2uxOLGcOZs33nDUY6i/btU=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/fontawesome/css/fontawesome.min.69685904d5c2a0c6258d03c207b778c10466edf6cea928cc0164c376b0ad0930.css integrity="sha256-aWhZBNXCoMYljQPCB7d4wQRm7fbOqSjMAWTDdrCtCTA=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/fontawesome/css/solid.min.6d585e78d28cce1200d39fb133c92ed83df01738da721d0f48fb6eac62d24e04.css integrity="sha256-bVheeNKMzhIA05+xM8ku2D3wFzjach0PSPturGLSTgQ=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/fontawesome/css/brands.min.6b00d96498d59caa0dbcf9b49d30d821915291f2ceb0e19248523c8607ff43fa.css integrity="sha256-awDZZJjVnKoNvPm0nTDYIZFSkfLOsOGSSFI8hgf/Q/o=" crossorigin=anonymous type=text/css><link rel="shortcut icon" href=/favicons/favicon.ico type=image/x-icon><link rel=apple-touch-icon sizes=180x180 href=/favicons/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicons/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicons/favicon-16x16.png><link rel=canonical href=http://vermillard.com/post/aws-traffic-mirror/><script type=text/javascript src=/js/anatole-header.min.f9132794301a01ff16550ed66763482bd848f62243d278f5e550229a158bfd32.js integrity="sha256-+RMnlDAaAf8WVQ7WZ2NIK9hI9iJD0nj15VAimhWL/TI=" crossorigin=anonymous></script><script type=text/javascript src=/js/anatole-theme-switcher.min.738c0e3a493854876aeab9e2316fd43f1936aeeac4cc6b3e60bb26456dba72ad.js integrity="sha256-c4wOOkk4VIdq6rniMW/UPxk2rurEzGs+YLsmRW26cq0=" crossorigin=anonymous></script><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://vermillard.com/images/aws-traffic-mirror.png"><meta name=twitter:title content="IoT Traffic capture and analysis on AWS"><meta name=twitter:description content="I work with different IoT protocols and their embedded clients every day, and troubleshooting product issues in the field can be tricky."><meta property="og:title" content="IoT Traffic capture and analysis on AWS"><meta property="og:description" content="I work with different IoT protocols and their embedded clients every day, and troubleshooting product issues in the field can be tricky."><meta property="og:type" content="article"><meta property="og:url" content="http://vermillard.com/post/aws-traffic-mirror/"><meta property="og:image" content="http://vermillard.com/images/aws-traffic-mirror.png"><meta property="article:section" content="post"><meta property="article:published_time" content="2024-09-02T00:00:00+00:00"><meta property="article:modified_time" content="2024-09-02T00:00:00+00:00"><meta property="og:site_name" content="About Me"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","articleSection":"post","name":"IoT Traffic capture and analysis on AWS","headline":"IoT Traffic capture and analysis on AWS","alternativeHeadline":"","description":"
      
        I work with different IoT protocols and their embedded clients every day, and troubleshooting product issues in the field can be tricky.


      


    ","inLanguage":"en","isFamilyFriendly":"true","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/vermillard.com\/post\/aws-traffic-mirror\/"},"author":{"@type":"Person","name":"Julien Vermillard"},"creator":{"@type":"Person","name":"Julien Vermillard"},"accountablePerson":{"@type":"Person","name":"Julien Vermillard"},"copyrightHolder":{"@type":"Person","name":"Julien Vermillard"},"copyrightYear":"2024","dateCreated":"2024-09-02T00:00:00.00Z","datePublished":"2024-09-02T00:00:00.00Z","dateModified":"2024-09-02T00:00:00.00Z","publisher":{"@type":"Organization","name":"Julien Vermillard","url":"http://vermillard.com/","logo":{"@type":"ImageObject","url":"http:\/\/vermillard.com\/favicons\/favicon-32x32.png","width":"32","height":"32"}},"image":["http://vermillard.com/images/aws-traffic-mirror.png"],"url":"http:\/\/vermillard.com\/post\/aws-traffic-mirror\/","wordCount":"846","genre":[],"keywords":["AWS","Cloud","Networking"]}</script></head><body class="body theme--light"><div class=wrapper><aside class=wrapper__sidebar><div class="sidebar
animated fadeInDown"><div class=sidebar__content><div class=sidebar__introduction><img class=sidebar__introduction-profileimage src=/images/profile.png alt="profile picture"><h1 class=sidebar__introduction-title><a href=/>About Me</a></h1><div class=sidebar__introduction-description><p>Julien Vermillard</p></div></div><ul class=sidebar__list><li class=sidebar__list-item><a href=https://linkedin.com/in/jvermillard/ rel=me aria-label=Linkedin title=Linkedin><i class="fab fa-linkedin fa-2x" aria-hidden=true></i></a></li><li class=sidebar__list-item><a href=https://twitter.com/vrmvrm rel=me aria-label=Twitter title=Twitter><i class="fab fa-twitter fa-2x" aria-hidden=true></i></a></li><li class=sidebar__list-item><a href=https://github.com/jvermillard/ rel=me aria-label=GitHub title=GitHub><i class="fab fa-github fa-2x" aria-hidden=true></i></a></li><li class=sidebar__list-item><a href=mailto:julien@vermillard.com rel=me aria-label=e-mail title=e-mail><i class="fas fa-envelope fa-2x" aria-hidden=true></i></a></li><li class=sidebar__list-item><a href=/documents/cv.pdf rel=me aria-label=resume title=resume><i class="fas fa-file-pdf fa-2x" aria-hidden=true></i></a></li></ul></div><footer class="footer footer__sidebar"><ul class=footer__list><li class=footer__item>&copy;
2021 - 2024</li></ul></footer><script type=text/javascript src=/js/medium-zoom.min.1248fa75275e5ef0cbef27e8c1e27dc507c445ae3a2c7d2ed0be0809555dac64.js integrity="sha256-Ekj6dSdeXvDL7yfoweJ9xQfERa46LH0u0L4ICVVdrGQ=" crossorigin=anonymous></script></div></aside><main class=wrapper__main><header class=header><div class="animated fadeInDown"><a role=button class=navbar-burger data-target=navMenu aria-label=menu aria-expanded=false><span aria-hidden=true class=navbar-burger__line></span>
<span aria-hidden=true class=navbar-burger__line></span>
<span aria-hidden=true class=navbar-burger__line></span></a><nav class=nav><ul class=nav__list id=navMenu><li class=nav__list-item><a href=/ title>Home</a></li><li class=nav__list-item><a href=/post/ title>Posts</a></li><li class=nav__list-item><a href=/portfolio/ title>Portfolio</a></li><li class=nav__list-item><a href=/publicspeaking/ title>Public Speaking</a></li></ul><ul class="nav__list nav__list--end"><li class=nav__list-item><div class=themeswitch><a title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></li></ul></nav></div></header><div class="post
animated fadeInDown"><div class=post__content><h1>IoT Traffic Capture and Analysis on AWS</h1><ul class=post__meta><li class=post__meta-item><em class="fas fa-calendar-day post__meta-icon"></em>
<span class=post__meta-text>2/9/2024</span></li><li class=post__meta-item><em class="fas fa-stopwatch post__meta-icon"></em>
<span class=post__meta-text>4-minute read</span></li></ul><p><img alt="Network Traffic Capture banner" src=/images/capture-banner.png></p><p>I work with different IoT protocols and their embedded clients every day, and troubleshooting product issues in the field can be tricky. When the steps to reproduce a problem aren’t clear, I like to capture the traffic during the issue. This helps me see what’s actually happening and how the client and server are interacting.</p><p>But getting a proper Wireshark capture file is tricky for two main reasons:</p><ul><li>First, getting one on the client side, which is remote and constrained and the property of the end customer, is either complicated or impossible in some cases.</li><li>Capturing traffic on the cloud/server side is challenging due to the traffic volume and the deployment&rsquo;s distributed nature: the load balancer and the protocol frontends are deployed as multiple machines (clusters).</li></ul><p>One solution I started to use within AWS environments is mirroring VPC network traffic. As part of its networking features, AWS proposes to copy and funnel the traffic of some network interface (ENI). In practice, it pipes the traffic of some ENI to a target one, following some filtering rules. For example, you take all the UDP, CoAP (or MQTT) traffic, incoming or outgoing, from your protocol frontend machines (or load-balancer), duplicate it, and encapsulate it in another protocol called VXLAN and send it to a target network interface of a given machine.</p><p>In a nutshell, VXLAN is a protocol that encapsulates Ethernet frames in UDP packets. It’s used for various tasks, like extending virtual networks or VPNs. In our case, the AWS traffic mirror uses it to capture and transfer network packets to another network interface.</p><p><img alt="AWS traffic Mirror" src=/images/aws-traffic-mirror.png></p><p>Now we receive the traffic on a machine. Before doing any analysis, we want to archive some of the traffic. The idea is to be able to look back in time to find the network traces of when a bug occurred.</p><p>In the first days or months of deployment, the archive&rsquo;s overall size probably fits on a regular disk. This is especially true with IoT protocols and applications, where you are conservative about the protocol footprint and the overall bandwidth.</p><p>We can use the good old tcpdump with file compression and rotation options. This tool’s less-known feature is that it can write, compress, rotate, and delete capture files like we usually do with logs file.</p><p>Note: there is a bug in some tcpdump versions packaged by some distribution (e.g., AWS Linux); tcpdump changes user/group during its operation: start as root, change to tcpdump, then back to root. One way to workaround is to set your capture directory owner and group as:</p><pre><code>mkdir /var/capture
chown root/var/capture
chmod 770 /var/capture
Then run :
tcpdump -i eth1 -C 200 -G 86400 -W 25 -w /var/capture/dump_$$(date +%%Y-%%m-%%d-%%H:%%M:%%S).pcap -z gzip -s 0 udp port 4789
</code></pre><p>Now that our traffic is centralized and stored, we can load it in Wireshark. Well, as soon as the pcap file starts to be in the gigabyte order, it’s barely usable. What I’m doing is pre-filtering with Tshark. First I concatenate the files of the time range where the communication I need is:</p><p><code>mergecap -w merged.pcap dump_2024–08–29–*.pcap*</code></p><p>Now, I either have the IP address of the device I want to inspect or not. If I don’t, I try to figure out its IP address. For CoAP communication over DTLS, I look for the first DTLS handshake containing the PSK Identity.</p><p><code>tshark -r merged.pcap -Y ‘dtls.handshake.identity == D:79:44:65:76:69:63:65’</code></p><p>This will start filtering the pcap file and show the first DTLS handshake packet with this specific, hexadecimal-encoded DTLS Identity. Of course, you can adapt it to other protocols.</p><p>Then, based on the IP of the device, I can extract a smaller file limited to the traffic of this IP address:</p><p><code>tshark -r merged.pcap -Y ‘ip.addr == 194.201.54.78’ -w filtered.pcap</code></p><p>This is a quick method to get a smaller file. But it’s still slow to use Shark on gigabytes of pcap files. Shark is a generic tool, so it’s slower than a specialized one for a specific use case. For my example of finding the packets related to a given DTLS Identity, I’m writing a specific small filter in Go using Go-Packet. Here is a code snippet to find a DTLS handshake:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>pcapFile</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nx>Args</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>handle</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>pcap</span><span class=p>.</span><span class=nf>OpenOffline</span><span class=p>(</span><span class=nx>pcapFile</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>defer</span> <span class=nx>handle</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nx>packetSource</span> <span class=o>:=</span> <span class=nx>gopacket</span><span class=p>.</span><span class=nf>NewPacketSource</span><span class=p>(</span><span class=nx>handle</span><span class=p>,</span> <span class=nx>handle</span><span class=p>.</span><span class=nf>LinkType</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=nx>packet</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>packetSource</span><span class=p>.</span><span class=nf>Packets</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>recordsByte</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>recordlayer</span><span class=p>.</span><span class=nf>UnpackDatagram</span><span class=p>(</span><span class=nx>packet</span><span class=p>.</span><span class=nf>ApplicationLayer</span><span class=p>().</span><span class=nf>LayerContents</span><span class=p>())</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;DTLS Unpack datagram error&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>continue</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>recordByte</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>recordsByte</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// is it an handshake record?
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>recordByte</span><span class=p>)</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=nx>recordByte</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=mh>0x16</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>h</span> <span class=o>:=</span> <span class=nx>recordlayer</span><span class=p>.</span><span class=nx>Header</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>      <span class=nx>err</span> <span class=p>=</span> <span class=nx>h</span><span class=p>.</span><span class=nf>Unmarshal</span><span class=p>(</span><span class=nx>recordByte</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Header decoding error&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=nx>handshakeBytes</span> <span class=o>:=</span> <span class=nx>recordByte</span><span class=p>[</span><span class=nx>recordlayer</span><span class=p>.</span><span class=nx>HeaderSize</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>         <span class=k>if</span> <span class=nx>handshake</span><span class=p>.</span><span class=nf>Type</span><span class=p>(</span><span class=nx>handshakeBytes</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span> <span class=o>==</span> <span class=nx>handshake</span><span class=p>.</span><span class=nx>TypeClientKeyExchange</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>           <span class=nx>msg</span> <span class=o>:=</span> <span class=nx>handshake</span><span class=p>.</span><span class=nx>MessageClientKeyExchange</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>           <span class=nx>msg</span><span class=p>.</span><span class=nx>KeyExchangeAlgorithm</span> <span class=p>=</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>           <span class=nx>err</span> <span class=o>:=</span> <span class=nx>msg</span><span class=p>.</span><span class=nf>Unmarshal</span><span class=p>(</span><span class=nx>handshakeBytes</span><span class=p>[</span><span class=mi>12</span><span class=p>:])</span>
</span></span><span class=line><span class=cl>           <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>             <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;ClientKeyExchange decoding error&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>           <span class=p>}</span>
</span></span><span class=line><span class=cl>           <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Identity:&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>msg</span><span class=p>.</span><span class=nx>IdentityHint</span><span class=p>),</span> <span class=nx>packet</span><span class=p>.</span><span class=nf>NetworkLayer</span><span class=p>().</span><span class=nf>NetworkFlow</span><span class=p>().</span><span class=nf>Src</span><span class=p>())</span>
</span></span><span class=line><span class=cl>         <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=c1>// Print out packet data
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>packet</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>In conclusion, capturing and analyzing IoT traffic in cloud environments can be challenging. I hope these methods, combining tcpdump and AWS traffic mirror, will help you to simplify debugging client-server interactions.</p></div><div class=post__footer><span><a class=tag href=/tags/aws/>AWS</a><a class=tag href=/tags/cloud/>Cloud</a><a class=tag href=/tags/networking/>Networking</a></span></div></div></main></div><footer class="footer footer__base"><ul class=footer__list><li class=footer__item>&copy;
2021 - 2024</li></ul></footer><script type=text/javascript src=/js/medium-zoom.min.1248fa75275e5ef0cbef27e8c1e27dc507c445ae3a2c7d2ed0be0809555dac64.js integrity="sha256-Ekj6dSdeXvDL7yfoweJ9xQfERa46LH0u0L4ICVVdrGQ=" crossorigin=anonymous></script></body></html>